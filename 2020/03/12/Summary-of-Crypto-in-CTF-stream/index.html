<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Summary-of-Crypto-in-CTF(stream) | 0xDktb's Blog</title><meta name="description" content="Stream Cipher - Many Time PadTheorem 流密钥循环使用  猜测密钥长度 Hamming Distance（二进制下两个等长字符串的比特位差异） 大小写英文字符两两的平均Hamming距离为2 ~ 3，而任意字符两两的平均Hamming距离为4  \therefore Assumed\quad c1&#x3D;p1\oplus key,c2&#x3D;p2\oplus key\\\\"><meta name="keywords" content="stream"><meta name="author" content="0xDktb"><meta name="copyright" content="0xDktb"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://dunkirkturbo.github.io/2020/03/12/Summary-of-Crypto-in-CTF-stream/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Summary-of-Crypto-in-CTF(stream)"><meta property="og:url" content="https://dunkirkturbo.github.io/2020/03/12/Summary-of-Crypto-in-CTF-stream/"><meta property="og:site_name" content="0xDktb's Blog"><meta property="og:description" content="Stream Cipher - Many Time PadTheorem 流密钥循环使用  猜测密钥长度 Hamming Distance（二进制下两个等长字符串的比特位差异） 大小写英文字符两两的平均Hamming距离为2 ~ 3，而任意字符两两的平均Hamming距离为4  \therefore Assumed\quad c1&#x3D;p1\oplus key,c2&#x3D;p2\oplus key\\\\"><meta property="og:image" content="https://dunkirkturbo.github.io/img/star.jpg"><meta property="article:published_time" content="2020-03-12T14:59:24.000Z"><meta property="article:modified_time" content="2020-06-03T12:11:07.662Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="Summary-of-Crypto-in-CTF(PRNG)" href="https://dunkirkturbo.github.io/2020/03/27/Summary-of-Crypto-in-CTF-PRNG/"><link rel="next" title="About Knapsack" href="https://dunkirkturbo.github.io/2020/03/02/About-Knapsack/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">37</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">8</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream-Cipher-Many-Time-Pad"><span class="toc-number">1.</span> <span class="toc-text">Stream Cipher - Many Time Pad</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Theorem"><span class="toc-number">1.1.</span> <span class="toc-text">Theorem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">1.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFSR-Basis"><span class="toc-number">2.</span> <span class="toc-text">LFSR - Basis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Theorem-1"><span class="toc-number">2.1.</span> <span class="toc-text">Theorem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-1"><span class="toc-number">2.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFSR-Correlation-Attack"><span class="toc-number">3.</span> <span class="toc-text">LFSR - Correlation Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Theorem-2"><span class="toc-number">3.1.</span> <span class="toc-text">Theorem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-2"><span class="toc-number">3.2.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#More"><span class="toc-number">3.3.</span> <span class="toc-text">More</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFSR-Known-Plain-Attack"><span class="toc-number">4.</span> <span class="toc-text">LFSR - Known Plain Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Theorem-3"><span class="toc-number">4.1.</span> <span class="toc-text">Theorem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-3"><span class="toc-number">4.2.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#More-1"><span class="toc-number">4.3.</span> <span class="toc-text">More</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><header class="post-bg" id="page-header" style="background-image: url(/img/star.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">0xDktb's Blog</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Summary-of-Crypto-in-CTF(stream)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-03-12 22:59:24"><i class="far fa-calendar-alt fa-fw"></i> Created 2020-03-12</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-06-03 20:11:07"><i class="fas fa-history fa-fw"></i> Updated 2020-06-03</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/Crypto/">Crypto</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="Stream-Cipher-Many-Time-Pad"><a href="#Stream-Cipher-Many-Time-Pad" class="headerlink" title="Stream Cipher - Many Time Pad"></a>Stream Cipher - Many Time Pad</h3><h4 id="Theorem"><a href="#Theorem" class="headerlink" title="Theorem"></a>Theorem</h4><ul>
<li><p>流密钥循环使用</p>
</li>
<li><p>猜测密钥长度</p>
<p>Hamming Distance（二进制下两个等长字符串的比特位差异）</p>
<p>大小写英文字符两两的平均Hamming距离为2 ~ 3，而任意字符两两的平均Hamming距离为4</p>
<script type="math/tex; mode=display">
\therefore Assumed\quad c1=p1\oplus key,c2=p2\oplus key\\\\
\because c1\oplus c2=p1\oplus p2\quad \therefore HammingDis(c1,c2)=HammingDis(p1,p2)</script><p>取合适的密钥长度上下界，进行分组计算汉明距离</p>
<p>将二元组(key_length, distance)按distance升序排列，取前五组验证即可</p>
</li>
<li><p>逐字节破解密钥</p>
<p>在猜测的密钥长度基础上，分割Cipher（用同一密钥字节加密的密文归入同组）</p>
<p><strong>字频分析</strong></p>
<p>遍历range(0xff)，和标准频率表（含空格和字母）内积最大的即猜测为正确密钥字节</p>
<p>因为不正确密钥字节下也可能内积很大，所以进行如下filter：</p>
<ul>
<li><p>decode(‘ascii’)出错 =&gt; return 0</p>
</li>
<li><p>cipher分组里为空格或字母的字符总数 &lt; len(cipher_fragment) // 1.5 =&gt; return 0</p>
</li>
</ul>
<p><strong>爆破空格</strong></p>
<p>基于空格和小写字母异或结果为对应大写字母，和大写字母异或结果为对应小写字母这一特性</p>
<p>对同一分组的cipher进行两两异或（相当于plain两两异或），记录每个字符与其他所有字符异或结果落在落在大小写字母和0x00上的次数，即可认为最大次数对应的字符位置上的明文为空格</p>
</li>
</ul>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> hexlify, unhexlify</span><br><span class="line"></span><br><span class="line">std_rate = &#123;<span class="string">' '</span>: <span class="number">0.18399868388580254</span>, <span class="string">'a'</span>: <span class="number">0.06528332604415538</span>, <span class="string">'b'</span>: <span class="number">0.012531342868095015</span>, <span class="string">'c'</span>: <span class="number">0.021018439349774747</span>, <span class="string">'d'</span>: <span class="number">0.03523431934577844</span>, <span class="string">'e'</span>: <span class="number">0.10261742470196494</span>, <span class="string">'f'</span>: <span class="number">0.019179805952664334</span>, <span class="string">'g'</span>: <span class="number">0.016178672025026573</span>, <span class="string">'h'</span>: <span class="number">0.050890812568726566</span>, <span class="string">'i'</span>: <span class="number">0.056467348737766584</span>, <span class="string">'j'</span>: <span class="number">0.0011847320400802188</span>, <span class="string">'k'</span>: <span class="number">0.006037640287976256</span>, <span class="string">'l'</span>: <span class="number">0.03310705983030898</span>,</span><br><span class="line">            <span class="string">'m'</span>: <span class="number">0.02089774777877722</span>, <span class="string">'n'</span>: <span class="number">0.056334978507447564</span>, <span class="string">'o'</span>: <span class="number">0.06194486601507346</span>, <span class="string">'p'</span>: <span class="number">0.014653281404481763</span>, <span class="string">'q'</span>: <span class="number">0.0009593791262805568</span>, <span class="string">'r'</span>: <span class="number">0.048625794552908115</span>, <span class="string">'s'</span>: <span class="number">0.051741663225580235</span>, <span class="string">'t'</span>: <span class="number">0.07413556318261176</span>, <span class="string">'u'</span>: <span class="number">0.023188985607049396</span>, <span class="string">'v'</span>: <span class="number">0.008010827191217628</span>, <span class="string">'w'</span>: <span class="number">0.018155155658972653</span>, <span class="string">'x'</span>: <span class="number">0.0014651754741116037</span>, <span class="string">'y'</span>: <span class="number">0.015511271998835988</span>, <span class="string">'z'</span>: <span class="number">0.0006457026385315064</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bytes_xor</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(y) &gt; len(x):</span><br><span class="line">        x, y = y, x</span><br><span class="line">    <span class="keyword">return</span> bytes([i ^ j <span class="keyword">for</span> i, j <span class="keyword">in</span> zip(x[:len(y)], y)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hamming_distance</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    dis = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> bytes_xor(x, y):</span><br><span class="line">        dis += bin(byte).count(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">return</span> dis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_length</span><span class="params">(cipher)</span>:</span></span><br><span class="line">    average_distances = []</span><br><span class="line">    <span class="keyword">for</span> key_length <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">40</span>):</span><br><span class="line">        cipher_fragments = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            <span class="keyword">if</span> key_length * (i + <span class="number">1</span>) &gt; len(cipher):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            cipher_fragments.append(</span><br><span class="line">                cipher[key_length * i: key_length * (i + <span class="number">1</span>)])</span><br><span class="line">        distance = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(cipher_fragments) - <span class="number">1</span>):</span><br><span class="line">            distance += hamming_distance(</span><br><span class="line">                cipher_fragments[i], cipher_fragments[i + <span class="number">1</span>])</span><br><span class="line">        distance /= (key_length * len(cipher_fragments))</span><br><span class="line">        average_distances.append((key_length, distance))</span><br><span class="line">    average_distances.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> average_distances</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string"># 字频分析</span></span><br><span class="line"><span class="string">def dot_multiply(p):</span></span><br><span class="line"><span class="string">    rate = [0] * 27</span></span><br><span class="line"><span class="string">    tmp_len = 0</span></span><br><span class="line"><span class="string">    for _ in p:</span></span><br><span class="line"><span class="string">        try:</span></span><br><span class="line"><span class="string">            _ = bytes([_]).decode('ascii')</span></span><br><span class="line"><span class="string">        except:</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        _ = _.lower()</span></span><br><span class="line"><span class="string">        if _ in std_rate:</span></span><br><span class="line"><span class="string">            tmp_len += 1</span></span><br><span class="line"><span class="string">            if _ == ' ':</span></span><br><span class="line"><span class="string">                rate[0] += 1</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                rate[ord(_) - ord('a') + 1] += 1</span></span><br><span class="line"><span class="string">    if not tmp_len or tmp_len &lt; len(p) // 1.5:</span></span><br><span class="line"><span class="string">        return 0</span></span><br><span class="line"><span class="string">    rate = [i / tmp_len for i in rate]</span></span><br><span class="line"><span class="string">    res = rate[0] * std_rate[' ']</span></span><br><span class="line"><span class="string">    for i in range(1, 27):</span></span><br><span class="line"><span class="string">        res += rate[i] * std_rate[chr(ord('a') + i - 1)]</span></span><br><span class="line"><span class="string">    return res</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def crack_key_fragment(cipher_fragment):</span></span><br><span class="line"><span class="string">    max_dotmul_res = 0</span></span><br><span class="line"><span class="string">    pro_key_fragment = 0</span></span><br><span class="line"><span class="string">    for key_fragment in range(0xff):</span></span><br><span class="line"><span class="string">        key_set = [key_fragment] * len(cipher_fragment)</span></span><br><span class="line"><span class="string">        plain_fragment = bytes_xor(key_set, cipher_fragment)</span></span><br><span class="line"><span class="string">        dotmul_res = dot_multiply(plain_fragment)</span></span><br><span class="line"><span class="string">        if dotmul_res &gt; max_dotmul_res:</span></span><br><span class="line"><span class="string">            max_dotmul_res = dotmul_res</span></span><br><span class="line"><span class="string">            pro_key_fragment = key_fragment</span></span><br><span class="line"><span class="string">    return pro_key_fragment</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def crack_key(cipher, average_distances):</span></span><br><span class="line"><span class="string">    for key_length, _ in average_distances[:5]:</span></span><br><span class="line"><span class="string">        key = []</span></span><br><span class="line"><span class="string">        cipher_fragments = [[] for _ in range(key_length)]</span></span><br><span class="line"><span class="string">        for i, byte in enumerate(cipher):</span></span><br><span class="line"><span class="string">            cipher_fragments[i % key_length].append(byte)</span></span><br><span class="line"><span class="string">        for cipher_fragment in cipher_fragments:</span></span><br><span class="line"><span class="string">            key.append(crack_key_fragment(cipher_fragment))</span></span><br><span class="line"><span class="string">        print(bytes(key))</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 爆破空格</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_key_fragment</span><span class="params">(cipher_fragment)</span>:</span></span><br><span class="line">    max_possible = <span class="number">0</span></span><br><span class="line">    pro_space = <span class="number">0</span>  <span class="comment"># 空格下标索引</span></span><br><span class="line">    letters = string.ascii_letters.encode(<span class="string">'ascii'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(cipher_fragment)):</span><br><span class="line">        possible = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(len(cipher_fragment)):</span><br><span class="line">            <span class="keyword">if</span> i == j:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            _ = cipher_fragment[i] ^ cipher_fragment[j]</span><br><span class="line">            <span class="keyword">if</span> _ <span class="keyword">in</span> letters <span class="keyword">or</span> _ == <span class="number">0</span>:</span><br><span class="line">                possible += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> possible &gt; max_possible:</span><br><span class="line">            max_possible = possible</span><br><span class="line">            pro_space = i</span><br><span class="line">    <span class="keyword">return</span> cipher_fragment[pro_space] ^ <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_key</span><span class="params">(cipher, average_distances)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> key_length, _ <span class="keyword">in</span> average_distances[:<span class="number">5</span>]:</span><br><span class="line">        key = []</span><br><span class="line">        cipher_fragments = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> range(key_length)]</span><br><span class="line">        <span class="keyword">for</span> i, byte <span class="keyword">in</span> enumerate(cipher):</span><br><span class="line">            cipher_fragments[i % key_length].append(byte)</span><br><span class="line">        <span class="keyword">for</span> cipher_fragment <span class="keyword">in</span> cipher_fragments:</span><br><span class="line">            key.append(crack_key_fragment(cipher_fragment))</span><br><span class="line">        print(bytes(key))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    masked_cipher = <span class="string">b'input your masked_cipher here'</span></span><br><span class="line">    salt = <span class="string">b'input your salt here'</span></span><br><span class="line">    cipher = bytes_xor(masked_cipher, salt *</span><br><span class="line">                       (len(masked_cipher) // len(salt) + <span class="number">1</span>))</span><br><span class="line">    average_distances = get_key_length(cipher)</span><br><span class="line">    crack_key(cipher, average_distances)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="LFSR-Basis"><a href="#LFSR-Basis" class="headerlink" title="LFSR - Basis"></a>LFSR - Basis</h3><h4 id="Theorem-1"><a href="#Theorem-1" class="headerlink" title="Theorem"></a>Theorem</h4><p>单个lfsr且已知抽头序列的情况下，只要有任意n个比特的流信息，即可轻易恢复完整流</p>
<p>等价于解n元1次方程（18年国赛streamgame）</p>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In[26]</span></span><br><span class="line">mask = <span class="number">0b10100100000010000000100010010100</span></span><br><span class="line">mask_bin = bin(mask)[<span class="number">2</span>:].rjust(<span class="number">32</span>, <span class="string">'0'</span>)</span><br><span class="line">feedback = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    <span class="keyword">if</span> mask_bin[i] == <span class="string">'1'</span>:</span><br><span class="line">        feedback.append(i)</span><br><span class="line">feedback.append(<span class="number">32</span>)</span><br><span class="line">delta = feedback[<span class="number">0</span>] + <span class="number">1</span></span><br><span class="line">feedback = [_ - delta <span class="keyword">for</span> _ <span class="keyword">in</span> feedback]</span><br><span class="line"></span><br><span class="line"><span class="comment"># In[27]</span></span><br><span class="line">cipher = open(<span class="string">"key"</span>, <span class="string">"rb"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># In[28]</span></span><br><span class="line">cipher_bin = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cipher:</span><br><span class="line">    cipher_bin += bin(c)[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">'0'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># In[30]</span></span><br><span class="line">cur = cipher_bin[:feedback[<span class="number">-1</span>] + <span class="number">1</span>]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    right = [cur[j] <span class="keyword">for</span> j <span class="keyword">in</span> feedback[<span class="number">1</span>:]]</span><br><span class="line">    left = str(right.count(<span class="string">'1'</span>) % <span class="number">2</span>)</span><br><span class="line">    flag = left + flag</span><br><span class="line">    cur = left + cur[:<span class="number">-1</span>]</span><br><span class="line">flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Out[36]</span></span><br><span class="line"><span class="string">'00110000011111010101001001100100'</span></span><br></pre></td></tr></table></figure>
<h3 id="LFSR-Correlation-Attack"><a href="#LFSR-Correlation-Attack" class="headerlink" title="LFSR - Correlation Attack"></a>LFSR - Correlation Attack</h3><h4 id="Theorem-2"><a href="#Theorem-2" class="headerlink" title="Theorem"></a>Theorem</h4><p>实际使用的lfsr往往是多个lfsr并行，并通过代数运算F来获得密钥流</p>
<p><img src= "/img/loading.gif" data-src="/2020/03/12/Summary-of-Crypto-in-CTF-stream/Snipaste_2020-03-13_15-00-29.png" alt></p>
<p>列出代数运算F的真值表，即可得到相关系数$p_{1},…,p_{n}$</p>
<p>一般认为在$p_{i}\geq 0.6$时，能使用相关攻击对第i个lfsr的密钥流实现恢复($p_{i}=0.75$时效果较好)</p>
<p>相关攻击使得复杂度从$\prod$优化为$\sum$，余下相关系数趋于0.5的lfsr采用暴力枚举即可</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">''</span></span><br><span class="line">R1_mask, R2_mask, R3_mask = <span class="number">0x10020</span>, <span class="number">0x4100c</span>, <span class="number">0x100002</span></span><br><span class="line">R1_partMask, R2_partMask, R3_partMask = <span class="number">0xffffff</span>, <span class="number">0xffffff</span>, <span class="number">0xffffff</span></span><br><span class="line">n1, n2, n3 = <span class="number">17</span>, <span class="number">19</span>, <span class="number">21</span></span><br><span class="line">R = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">crack_state = [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>]  <span class="comment"># 相关攻击是否已完成(退出其他线程)</span></span><br><span class="line">start = time.clock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_stream</span><span class="params">(read_length)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> cipher</span><br><span class="line">    cipher_bytes = open(<span class="string">'cipher'</span>, <span class="string">'rb'</span>).read(read_length)</span><br><span class="line">    cipher = <span class="string">''</span>.join(bin(c)[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">'0'</span>) <span class="keyword">for</span> c <span class="keyword">in</span> cipher_bytes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(R, mask, partMask)</span>:</span></span><br><span class="line">    output = (R &lt;&lt; <span class="number">1</span>) &amp; partMask</span><br><span class="line">    i = (R &amp; mask) &amp; partMask</span><br><span class="line">    lastbit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">        lastbit ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">        i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">    output ^= lastbit</span><br><span class="line">    <span class="keyword">return</span> (output, lastbit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_lfsr</span><span class="params">(R, mask, partMask, N)</span>:</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">        (R, out) = lfsr(R, mask, partMask)</span><br><span class="line">        ret += str(out)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_round</span><span class="params">(R1, R2, R3)</span>:</span></span><br><span class="line">    (R1_new, x1) = lfsr(R1, R1_mask, R1_partMask)</span><br><span class="line">    (R2_new, x2) = lfsr(R2, R2_mask, R2_partMask)</span><br><span class="line">    (R3_new, x3) = lfsr(R3, R3_mask, R3_partMask)</span><br><span class="line">    <span class="keyword">return</span> (R1_new, R2_new, R3_new, (x1 * x2) ^ ((x2 ^ <span class="number">1</span>) * x3))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(R1, R2, R3, N)</span>:</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">        (R1, R2, R3, out) = single_round(R1, R2, R3)</span><br><span class="line">        ret += str(out)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">correlation</span><span class="params">(single_cipher, cipher)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(len(single_cipher) == len(cipher))</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> zip(single_cipher, cipher):</span><br><span class="line">        <span class="keyword">if</span> i == j:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count / len(cipher)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_p</span><span class="params">()</span>:</span></span><br><span class="line">    p1, p2, p3 = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x1 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> x2 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> x3 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                value = (x1 * x2) ^ ((x2 ^ <span class="number">1</span>) * x3)</span><br><span class="line">                p1 += x1 ^ value ^ <span class="number">1</span></span><br><span class="line">                p2 += x2 ^ value ^ <span class="number">1</span></span><br><span class="line">                p3 += x3 ^ value ^ <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> (p1 / <span class="number">8</span>, p2 / <span class="number">8</span>, p3 / <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_key</span><span class="params">(p, mask, partMask, low, high, index)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> R</span><br><span class="line">    <span class="keyword">global</span> crack_state</span><br><span class="line">    <span class="keyword">for</span> guess_R <span class="keyword">in</span> range(low, high):</span><br><span class="line">        <span class="keyword">if</span> crack_state[index - <span class="number">1</span>] == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        single_cipher = single_lfsr(guess_R, mask, partMask, len(cipher))</span><br><span class="line">        correlation_value = correlation(single_cipher, cipher)</span><br><span class="line">        <span class="keyword">if</span> correlation_value &gt;= (p - <span class="number">0.05</span>) <span class="keyword">and</span> correlation_value &lt;= (p + <span class="number">0.05</span>):</span><br><span class="line">            print((hex(guess_R)[<span class="number">2</span>:].rjust(<span class="number">6</span>, <span class="string">'0'</span>), correlation_value))</span><br><span class="line">            R[index - <span class="number">1</span>] = guess_R</span><br><span class="line">            crack_state[index - <span class="number">1</span>] = <span class="literal">True</span></span><br><span class="line">            end = time.clock()</span><br><span class="line">            print(<span class="string">'cost &#123;&#125;s'</span>.format(end - start))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force</span><span class="params">(low, high)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> R</span><br><span class="line">    <span class="keyword">global</span> crack_state</span><br><span class="line">    <span class="keyword">for</span> guess_R <span class="keyword">in</span> range(low, high):</span><br><span class="line">        <span class="keyword">if</span> crack_state[<span class="number">1</span>] == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        guess_cipher = encrypt(R[<span class="number">0</span>], guess_R, R[<span class="number">2</span>], len(cipher))</span><br><span class="line">        <span class="keyword">if</span> guess_cipher == cipher:</span><br><span class="line">            R[<span class="number">1</span>] = guess_R</span><br><span class="line">            crack_state[<span class="number">1</span>] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    init_stream(<span class="number">256</span>)</span><br><span class="line">    <span class="comment"># crack_p (step 1)</span></span><br><span class="line">    (p1, p2, p3) = crack_p()</span><br><span class="line">    print((p1, p2, p3))</span><br><span class="line">    <span class="comment"># correlation attack (step 2)</span></span><br><span class="line">    threads = []</span><br><span class="line">    low = <span class="number">2</span>**(n1 - <span class="number">1</span>)</span><br><span class="line">    crack_length = low // <span class="number">16</span></span><br><span class="line">    high = low + crack_length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        t = threading.Thread(target=crack_key, args=(</span><br><span class="line">            p1, R1_mask, R1_partMask, low, high, <span class="number">1</span>))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        low = high</span><br><span class="line">        high += crack_length</span><br><span class="line">    low = <span class="number">2</span>**(n3 - <span class="number">1</span>)</span><br><span class="line">    crack_length = low // <span class="number">16</span></span><br><span class="line">    high = low + crack_length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        t = threading.Thread(target=crack_key, args=(</span><br><span class="line">            p3, R3_mask, R3_partMask, low, high, <span class="number">3</span>))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        low = high</span><br><span class="line">        high += crack_length</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    <span class="comment"># brute_force (step 3)</span></span><br><span class="line">    threads = []</span><br><span class="line">    low = <span class="number">2</span>**(n2 - <span class="number">1</span>)</span><br><span class="line">    crack_length = low // <span class="number">16</span></span><br><span class="line">    high = low + crack_length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        t = threading.Thread(target=brute_force, args=(low, high))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        low = high</span><br><span class="line">        high += crack_length</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    end = time.clock()</span><br><span class="line">    print(<span class="string">'cost &#123;&#125;s'</span>.format(end - start))</span><br><span class="line">    print(hex(R[<span class="number">0</span>])[<span class="number">2</span>:].rjust(<span class="number">6</span>, <span class="string">'0'</span>), end=<span class="string">''</span>)</span><br><span class="line">    print(hex(R[<span class="number">1</span>])[<span class="number">2</span>:].rjust(<span class="number">6</span>, <span class="string">'0'</span>), end=<span class="string">''</span>)</span><br><span class="line">    print(hex(R[<span class="number">2</span>])[<span class="number">2</span>:].rjust(<span class="number">6</span>, <span class="string">'0'</span>), end=<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(0.75, 0.5, 0.75)</span><br><span class="line">('01b9cb', 0.74755859375)</span><br><span class="line">cost 30.8923027s</span><br><span class="line">('16b2f3', 0.74169921875)</span><br><span class="line">cost 362.5205596s</span><br><span class="line">cost 436.23293620000004s</span><br><span class="line">01b9cb05979c16b2f3</span><br></pre></td></tr></table></figure>
<h4 id="More"><a href="#More" class="headerlink" title="More"></a>More</h4><p>exp对应的是强网杯streamgame3，在pypy3下大约七八分钟能出答案，但python3估计就有点儿慢了-.-</p>
<p>网上现在传的版本大多也都只是相关攻击，顶多在多线程上进行部分优化</p>
<p>快速相关攻击的A算法原理理解很容易，但我编写脚本测试后发现出不来…暂时搁置</p>
<p>安全客上有一篇讲LFSR相关攻击的文章，分别用了开普敦大学的轮子和z3约束来进行求解，链接如下</p>
<p><a href="https://www.anquanke.com/post/id/184828" target="_blank" rel="noopener">https://www.anquanke.com/post/id/184828</a></p>
<h3 id="LFSR-Known-Plain-Attack"><a href="#LFSR-Known-Plain-Attack" class="headerlink" title="LFSR - Known Plain Attack"></a>LFSR - Known Plain Attack</h3><h4 id="Theorem-3"><a href="#Theorem-3" class="headerlink" title="Theorem"></a>Theorem</h4><p>LFSR的KPA问题（已知明文长度要大等于两倍的LFSR级数n）</p>
<ul>
<li>对LFSR级数n进行range(2, len(stream) // 2)上的爆破（stream是已知明文段）</li>
<li>因为$len(stream)//2\geq n$，所以每个猜测级数i下均对应至少i个i元线性方程（系数矩阵秩&lt;i情况一般不考虑）</li>
<li>LFSR的下一位只受当前n位和抽头序列影响，因此得到n个GF(2)上形如$\sum_{i=1}^{n}p_{i}$, if stream[i]==1的线性方程，于是抽头序列$\\{p_{i}\\}$获知，恢复全部明文并校验即可</li>
</ul>
<h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, p21, p22, p23, p24, p25, p26, p27, p28, p29, p30, p31, p32, p33, p34, p35, p36, p37, p38, p39, p40, p41, p42, p43, p44, p45, p46, p47 = BitVecs(</span><br><span class="line">    <span class="string">'p0 p1 p2 p3 p4 p5 p6 p7 p8 p9 p10 p11 p12 p13 p14 p15 p16 p17 p18 p19 p20 p21 p22 p23 p24 p25 p26 p27 p28 p29 p30 p31 p32 p33 p34 p35 p36 p37 p38 p39 p40 p41 p42 p43 p44 p45 p46 p47'</span>, <span class="number">1</span>)</span><br><span class="line">p = [p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, p21, p22, p23, p24,</span><br><span class="line">     p25, p26, p27, p28, p29, p30, p31, p32, p33, p34, p35, p36, p37, p38, p39, p40, p41, p42, p43, p44, p45, p46, p47]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_stream</span><span class="params">(known_plain, known_cipher)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(len(known_plain) == len(known_cipher) <span class="keyword">and</span> len(known_plain) &lt;= <span class="number">24</span>)</span><br><span class="line">    known_plain_dec = int(known_plain, <span class="number">16</span>)</span><br><span class="line">    <span class="comment">#known_plain_dec = int('89504E470D0A1A0A0000000D', 16)</span></span><br><span class="line">    known_cipher_dec = int(known_cipher, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> bin(known_plain_dec ^ known_cipher_dec)[<span class="number">2</span>:].rjust(<span class="number">4</span> * len(known_plain), <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_key</span><span class="params">(stream, key_length)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(len(stream) &gt;= <span class="number">2</span> * key_length)</span><br><span class="line">    solver = Solver()</span><br><span class="line">    <span class="comment">#var_name = ['p' + str(i) for i in range(key_length)]</span></span><br><span class="line">    <span class="comment">#exec('&#123;&#125;=BitVecs(\'&#123;&#125;\',1)'.format(",".join(var_name), " ".join(var_name)))</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(stream) - key_length):</span><br><span class="line">        cur = stream[i: i + key_length + <span class="number">1</span>]</span><br><span class="line">        equation = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(key_length):</span><br><span class="line">            <span class="keyword">if</span> cur[j] == <span class="string">'1'</span>:</span><br><span class="line">                equation += <span class="string">'p'</span> + str(j) + <span class="string">'+'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> len(equation):</span><br><span class="line">            equation = equation[:<span class="number">-1</span>] + <span class="string">' == '</span> + str(cur[<span class="number">-1</span>])</span><br><span class="line">            solver.add(eval(equation))</span><br><span class="line">    <span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">        m = solver.model()</span><br><span class="line">        feedback = <span class="string">''</span>.join([str(m[p[i]]) <span class="keyword">for</span> i <span class="keyword">in</span> range(key_length)])</span><br><span class="line">        <span class="comment">#print('[&#123;&#125;]: ini_key = \'&#123;&#125;\' ; feedback = \'&#123;&#125;\''.format(str(key_length), stream[:key_length], feedback))</span></span><br><span class="line">        <span class="keyword">return</span> (stream[:key_length], feedback)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(cur, feedback)</span>:</span></span><br><span class="line">    cur_num = int(cur, <span class="number">2</span>)</span><br><span class="line">    output = (cur_num &lt;&lt; <span class="number">1</span>) &amp; ((<span class="number">1</span> &lt;&lt; len(feedback)) - <span class="number">1</span>)</span><br><span class="line">    i = (cur_num &amp; int(feedback, <span class="number">2</span>)) &amp; ((<span class="number">1</span> &lt;&lt; len(feedback)) - <span class="number">1</span>)</span><br><span class="line">    lastbit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">        lastbit ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">        i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">    output ^= lastbit</span><br><span class="line">    output = bin(output)[<span class="number">2</span>:].rjust(len(cur), <span class="string">'0'</span>)</span><br><span class="line">    <span class="keyword">return</span> (output, lastbit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_byte</span><span class="params">(cur, feedback)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(cur) &gt;= <span class="number">8</span>:</span><br><span class="line">        byte = int(cur[:<span class="number">8</span>], <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            cur, lastbit = lfsr(cur, feedback)</span><br><span class="line">        <span class="keyword">return</span> (cur, byte)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        byte = cur</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span> - len(cur)):</span><br><span class="line">            cur, lastbit = lfsr(cur, feedback)</span><br><span class="line">            byte += str(lastbit)</span><br><span class="line">        <span class="keyword">return</span> (cur, int(byte, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    cipher = open(<span class="string">'lfsr.png.encrypt'</span>, <span class="string">"rb"</span>).read()</span><br><span class="line">    <span class="comment"># kpa_attack for length(hex) &lt;= 24</span></span><br><span class="line">    stream = init_stream(<span class="string">'89504E470D0A1A0A0000000D'</span>,</span><br><span class="line">                         <span class="string">'e63b037e74c01aeefd6552ef'</span>)</span><br><span class="line">    <span class="keyword">for</span> key_length <span class="keyword">in</span> range(<span class="number">2</span>, len(stream) // <span class="number">2</span>):</span><br><span class="line">        key, feedback = crack_key(stream, key_length)</span><br><span class="line">        <span class="keyword">if</span> (key, feedback) != (<span class="literal">False</span>, <span class="literal">False</span>):</span><br><span class="line">            cur = key</span><br><span class="line">            fw = open(<span class="string">'lsfr_&#123;&#125;.png'</span>.format(key_length), <span class="string">'wb'</span>)</span><br><span class="line">            plain = <span class="string">b''</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(cipher)):</span><br><span class="line">                cur, byte = get_byte(cur, feedback)</span><br><span class="line">                plain += bytes([cipher[i] ^ byte])</span><br><span class="line">            fw.write(plain)</span><br><span class="line">            fw.close()</span><br><span class="line">            print(<span class="string">'lsfr_&#123;&#125;.png ok!'</span>.format(key_length))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h4 id="More-1"><a href="#More-1" class="headerlink" title="More"></a>More</h4><p>exp对应2020i春秋公益赛的一道lfsr-kpa（已知png文件头，与cipher异或即可将问题转化为lfsr-kpa问题）</p>
<p>lfsr-kpa可以不局限于开头，密钥流中任意段已知2n个bit均可进行抽头序列的猜测（lfsr在已知n个连续比特和抽头序列的情况下一定能恢复完整密钥流）</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">0xDktb</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://dunkirkturbo.github.io/2020/03/12/Summary-of-Crypto-in-CTF-stream/">https://dunkirkturbo.github.io/2020/03/12/Summary-of-Crypto-in-CTF-stream/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/stream/">stream</a></div><div class="post_share"><div class="social-share" data-image="/img/star.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wx.jpg" alt="wechat" onclick="window.open('/img/wx.jpg')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/zfb.jpg" alt="alipay" onclick="window.open('/img/zfb.jpg')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/27/Summary-of-Crypto-in-CTF-PRNG/"><img class="prev-cover" data-src="/img/star.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Summary-of-Crypto-in-CTF(PRNG)</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/02/About-Knapsack/"><img class="next-cover" data-src="/img/star.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">About Knapsack</div></div></a></div></nav></article></main><footer id="footer" style="background-image: url(/img/star.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2023 By 0xDktb</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://www.beian.miit.gov.cn" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>湘ICP备19022012号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font_plus" title="Increase Font Size"><i class="fas fa-plus"></i></button><button id="font_minus" title="Decrease Font Size"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button></div><div id="rightside-config-show"><button id="rightside_config" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script></body></html>